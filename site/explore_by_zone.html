<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SelectFeature Control on Layer.Vector</title> 
    <link rel="stylesheet" href="../dist/ol_style.css" type="text/css">
    <style type="text/css">
        html, body, #map {
            margin: 0;
            width: 100%;
            height: 100%;
        }
        li {
            list-style: none;
        }
        #info {
            position: absolute;
            right: 0px;
            top: 0px;
            z-index: 9999;
            background: rgba(255,255,255,0.5);
            padding:10px;
        }
        .node {
          border: solid 1px #bbb;
          font: 10px sans-serif;
          line-height: 12px;
          overflow: hidden;
          position: absolute;
          text-indent: 2px;
        }
    </style>
    <script src="../dist/OpenLayers.js"></script>
    <script src="../dist/d3.v3.min.js"></script>
    <script>
        var zoneData = null;  // Makes data-map.js happy
    </script>
    <script src="food_zones/data-map.js"></script>  

    <script type="text/javascript">
        var map, selectControl;
        var width = 150;
        var height = 450;
        var margin = {top: 65, right: 10, bottom: 10, left: 10};
        var selectedValue = 'acres';
        var nSelected = 0;
        var acresSelected = 0;
        var suspendRedraw = false;
        var color = d3.scale.category10();

        var vectors;
        var treeData, treeDataTemplate, treemap, node;


        function position() {
          this.style("left", function(d) { return d.x + "px"; })
              .style("top", function(d) { return d.y + "px"; })
              .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
              .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
        } 

        function calcCharts(feature, type) {
            attrs = feature.feature.attributes;

            // Loop through crops in treeData and
            // add or subtract based on the selected/unselected features attrs
            for (i in treeData.children) {
                var cat = treeData.children[i];
                for (j in cat.children) {
                    var crop = cat.children[j];
                    featAcres = attrs["acres_" + cat.name + "_" + crop.name + "_z_ac"];
                    featYield = attrs["acres_" + cat.name + "_" + crop.name + "_z_ac"];

                    var newacres, newyield;
                    if (type === "select") {
                        newacres = crop.acres + featAcres; 
                        newyield = crop.yield + featYield;
                    } else if (type === "unselect") {
                        newacres = crop.acres - featAcres;
                        newyield = crop.yield - featYield;
                    }
                    treeData.children[i].children[j].acres = newacres;
                    treeData.children[i].children[j].yield = newyield;
                }
            }
        }

        function selectRegion(region) {
            suspendRedraw = true;
            selectControl.unselectAll();

            var feature;
            // TODO
            // myFeatures=myVectorLayer.getFeaturesByAttribute("myAttribute","myValue")
            // then selectControl.select(myFeature)
            for (var f in vectors.features) {
                feature = vectors.features[f];
                if (region == 1) {
                    if (feature.attributes.id < 50) {
                        selectControl.select(feature);
                    }
                } else if (region == 2) {
                    if (feature.attributes.id >= 50 && 
                        feature.attributes.id <= 100) {
                        selectControl.select(feature);
                    }
                } else if (region == 3) {
                    if (feature.attributes.id > 100) {
                        selectControl.select(feature);
                    }
                }
            }

            redrawTreemap(selectedValue);
            suspendRedraw = false;
        }

        function counter(selectedFeatures) {
            nSelected = selectedFeatures.length; 

            if (nSelected == 0) {
                document.getElementById('treemap').style.display = 'none';
            } else {
                document.getElementById('treemap').style.display = 'block';
            }

            document.getElementById('counter').innerHTML = nSelected;

            var totalAcres = 0;
            for (var i = selectedFeatures.length - 1; i >= 0; i--) {
                totalAcres += selectedFeatures[i].attributes.area_in_acres;
            };
            document.getElementById('acres').innerHTML = Math.round(totalAcres);
        }

        var featureSelected = function(feature) {
            counter(this.selectedFeatures);
            calcCharts(feature, 'select');
            if (!suspendRedraw) {
                redrawTreemap(selectedValue);
            }
        }

        var featureUnselected = function(feature) {
            counter(this.selectedFeatures);
            calcCharts(feature, 'unselect');
            if (!suspendRedraw) {
                redrawTreemap(selectedValue);
            }
        }

        function init(){
            map = new OpenLayers.Map('map');

            var baseLayer = new OpenLayers.Layer.XYZ( "ESRI",
                "http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/${z}/${y}/${x}",
                {sphericalMercator: true}
            ); 

            var styleMap = new OpenLayers.StyleMap({
                'default': new OpenLayers.Style({
                    fillOpacity: 0.5,
                    fillColor: 'white',
                    strokeColor: '#555555',
                    strokeWidth: 0.2,
                    strokeOpacity: 0.8}),
                'select': new OpenLayers.Style({
                    fillOpacity: 0.8,
                    fillColor: '#ffff00',
                    strokeColor: '#555555',
                    strokeWidth: 0.5,
                    strokeOpacity: 0.2})
            });

            vectors = new OpenLayers.Layer.Vector("GeoJSON", {
                styleMap: styleMap,
                projection: "EPSG:4326",
                strategies: [new OpenLayers.Strategy.Fixed()],
                protocol: new OpenLayers.Protocol.HTTP({
                    url: "food_zones/food_zones_all.geojson",
                    format: new OpenLayers.Format.GeoJSON()
                })
            });

            vectors.events.on({
                'featureselected': featureSelected,
                'featureunselected': featureUnselected,
                "loadend": function(e) {
                    initTreemap();
                }
            });

            map.addLayers([baseLayer, vectors]);
            
            selectControl = new OpenLayers.Control.SelectFeature(
                vectors,
                {
                    clickout: true, 
                    toggle: true,
                    multiple: false,
                    hover: false,
                    toggleKey: "ctrlKey", // ctrl key removes from selection
                    multipleKey: "shiftKey", // shift key adds to selection
                    //box: true
                }
            );            
            
            // click-drag to move map
            // Unfortunately this makes shift-select behave oddly (zooms after selection)
            // For now we turn this off
            // selectControl.handlers.feature.stopDown = false;

            map.addControl(selectControl);
            map.setCenter(new OpenLayers.LonLat(-120, 42).transform("EPSG:4326", "EPSG:900913"), 5);
            selectControl.activate();     
        }

        function resetTreemap() {
            for (var i in treeData.children) {
                var cat = treeData.children[i];
                for (var j in cat.children) {
                    treeData.children[i].children[j].acres = 0;
                    treeData.children[i].children[j].yield = 0;
                }
            }
        }

        function randomizeTreemap() {
            for (var i in treeData.children) {
                var cat = treeData.children[i];
                for (var j in cat.children) {
                    var newacres = Math.floor(Math.random() * 2) + 5;
                    var newyield = Math.floor(Math.random() * 2) + 5;
                    treeData.children[i].children[j].acres = newacres;
                    treeData.children[i].children[j].yield = newyield;
                }
            }
        }

        function toggleControl(element) {
            if(element.value == 'nav' && element.checked) {
                selectControl.deactivate();
            } else {
                selectControl.activate();
            }
        }

        function redrawTreemap(v) {
            selectedValue = v;
            var value = function(d) { return d[v]; };

            node
                .data(treemap.value(value).nodes)
              .transition()
                .duration(1500)
                .call(position)
                .text(function(d) { 
                    if (d.dy < 12) { return null; }
                    return d.children ? null : d.fullname; 
              });

            return true;
        }

        function getFullName(cat, crop) {
            var name = types[cat.toLowerCase()].options[crop.toLowerCase()].name;
            return name;
        }

        function initTreemap() {
            // Create the following data structure based on the crop available 
            // treeDataTemplate = {
            //     children: [
            //       { name: "br",
            //         children:[
            //           { name: "br01", fullname: "br01", acres: 0, yield: 0},
            //           { name: "br02", fullname: "br02", acres: 0, yield: 0}
            //       ]},
            //       { name: "fc", 
            //         children:[
            //           { name: "fc02", fullname: "fc02", acres: 0, yield: 0},
            //           { name: "fc34", fullname: "fc34", acres: 0, yield: 0}
            //       ]}
            //     ]
            // };
            treeDataTemplate = {children: []};

            
            var attrs = map.layers[1].features[0].attributes;
            var start = "acres_";
            var end = "_z_ac";
            for(var k in attrs) {
                if (k.lastIndexOf(start, 0) === 0 &&  // startswith
                    k.indexOf(end, k.length - end.length) !== -1 // endswith
                    ) {
                    var newk = k.replace(start,"").replace(end,"");
                    var parts = newk.split("_");
                    var catname = parts[0];
                    // Ignore fs
                    if (catname == "fs") { continue; }
                    
                    var cropname = parts[1];
                    var catidx = false;
                    for (a in treeDataTemplate.children) {
                        if (treeDataTemplate.children[a].name == 'catname') {
                            catidx = a;
                        } 
                    }
                    if (catidx === false) {
                        treeDataTemplate.children.push({name: catname, children: []});
                        catidx = treeDataTemplate.children.length - 1;
                    }
                    treeDataTemplate.children[catidx].children.push(
                        { name: cropname, 
                          fullname: getFullName(catname, cropname),
                          acres: 0,
                          yield: 0}
                    );
                }
            }

            treeData = JSON.parse( JSON.stringify( treeDataTemplate ) );  // copy

            // randomize to get good sticky structure
            randomizeTreemap();

            treemap = d3.layout.treemap()
                .size([width, height])
                //.mode('squarify')
                .mode('dice')
                .ratio(1.6)  // 1.618 == .5 * (1 + Math.sqrt(5))
                .sticky(true)
                .value(function (d) { return d.acres; });


            var div = d3.select("body").append("div")
                .style("position", "absolute")
                .style("z-index", "9999")
                .attr("id", "treemap")
                .style("display", "none")
                .style("width", (width + margin.left + margin.right) + "px")
                .style("height", (height + margin.top + margin.bottom) + "px")
                .style("left", margin.left + "px")
                .style("top", margin.top + "px");

            node = div.datum(treeData).selectAll(".node")
              .data(treemap.nodes)
            .enter().append("div")
              .attr("class", "node")
              .call(position)
              .style("background", 
                    function(d) {return d.children ? null : color(d.parent.name); })

            resetTreemap();
        }
    </script>

  </head>

  <body onload="init()">
    <div id="map" class="bigmap"></div>
    <div id="info">
        <div>
            <span id="counter">0</span> zones selected,
            <span id="acres">0</span> acres
        </div>
        <hr>
        <div>
            <p> Select zones with click <br> (use shift to add, ctl to remove) OR</p>
            <p> Select a pre-defined region </p>
            <ul>
                <li> <a href="#" onclick="selectRegion(3)">North</a> </li>
                <li> <a href="#" onclick="selectRegion(2)">Central</a> </li>
                <li> <a href="#" onclick="selectRegion(1)">South</a> </li>
            </ul>
        </div>
    </div>
  </body>
</html>
